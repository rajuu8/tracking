<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Admin Pro - Leaflet Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; background: #1a202c; color: white; }
        #sidebar { width: 340px; background: #1a202c; padding: 20px; border-right: 1px solid #2d3748; overflow-y: auto; z-index: 1000; box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
        #map { flex: 1; height: 100%; z-index: 1; }
        
        h2 { margin-top: 0; display: flex; justify-content: space-between; align-items: center; font-size: 1.4rem; }
        .btn-main { background: #4a5568; color: white; border: none; padding: 10px; border-radius: 8px; width: 100%; cursor: pointer; margin-bottom: 10px; font-weight: bold; transition: 0.2s; }
        .btn-main:hover { background: #e53e3e; }

        .user-card { background: #2d3748; padding: 15px; border-radius: 12px; margin-bottom: 12px; cursor: pointer; border: 1px solid transparent; transition: 0.3s; position: relative; }
        .user-card:hover { border-color: #63b3ed; background: #3a4a63; }
        
        .battery-tag { font-weight: bold; font-size: 12px; padding: 2px 6px; border-radius: 4px; background: #234e33; color: #48bb78; }
        .battery-low { background: #742a2a; color: #f56565; animation: blink 1s infinite; }
        
        .delete-user { position: absolute; top: 10px; right: 10px; color: #a0aec0; font-size: 18px; cursor: pointer; }
        .delete-user:hover { color: #f56565; }

        .sos-alert { border: 2px solid #f56565 !important; background: #4a1d1d !important; animation: shake 0.5s infinite; }
        .geofence-alert { border: 2px solid #f6e05e !important; }
        
        @keyframes blink { 50% { opacity: 0.5; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(5px); } 75% { transform: translateX(-5px); } }
        
        .last-seen { font-size: 11px; color: #cbd5e0; margin-top: 8px; display: block; }
        .zone-status { font-size: 10px; font-weight: bold; margin-top: 5px; color: #f6e05e; }
    </style>
</head>
<body>

<audio id="sosSound" src="https://actions.google.com/sounds/v1/alarms/emergency_siren.ogg" preload="auto"></audio>

<div id="sidebar">
    <h2>Admin Panel üõ°Ô∏è</h2>
    <button class="btn-main" onclick="clearAllPaths()">üßπ Clear All Map Lines</button>
    <p style="font-size: 11px; color: #a0aec0;">Safe Zone: 1 KM Radius</p>
    <hr style="border: 0; border-top: 1px solid #2d3748; margin: 15px 0;">
    <div id="user-list">Fetching family members...</div>
</div>
<div id="map"></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCZz90P8npkRcL0ZctIelDFbKRN48BsZzk",
        authDomain: "tracking-7494e.firebaseapp.com",
        projectId: "tracking-7494e",
        storageBucket: "tracking-7494e.firebasestorage.app",
        messagingSenderId: "861816870090",
        appId: "1:861816870090:web:4dec49659b3806fcd49033"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let map, markers = {}, paths = {}, userAlerts = new Set();
    
    // --- GEOFENCE SETTINGS ---
    const HOME_LAT = 28.6139; // Apna Home Lat dalein
    const HOME_LNG = 77.2090; // Apna Home Lng dalein
    const SAFE_RADIUS = 1000; // 1000 meters = 1 KM

    function initMap() {
        map = L.map('map').setView([HOME_LAT, HOME_LNG], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Safe Zone Circle on Map
        L.circle([HOME_LAT, HOME_LNG], {
            color: '#48bb78',
            fillColor: '#48bb78',
            fillOpacity: 0.1,
            radius: SAFE_RADIUS
        }).addTo(map);

        listenToLocations();
        listenToAlerts();
    }

    // Distance calculate karne ka formula
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000; // Radius of earth in meters
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function listenToLocations() {
    // Ye real-time listener hai jo bina page refresh kiye data lega
    db.collection("locations").onSnapshot(snapshot => {
        const listDiv = document.getElementById('user-list');
        listDiv.innerHTML = ''; // Pehle list saaf karein

        snapshot.forEach(doc => {
            const data = doc.data();
            const name = data.userName || doc.id; // User ka naam
            
            // Check karein ki data mil raha hai ya nahi
            if (data.lat && data.lng) {
                const lat = parseFloat(data.lat);
                const lng = parseFloat(data.lng);
                const battery = data.battery || 0;
                const pos = [lat, lng];

                // 1. Sidebar Card Update
                listDiv.innerHTML += `
                    <div class="user-card" onclick="map.setView([${lat}, ${lng}], 16)">
                        <strong>${name}</strong>
                        <span class="battery-tag">üîã ${battery}%</span>
                        <p style="font-size:10px; color:#a0aec0; margin:5px 0 0;">
                            Lat: ${lat.toFixed(4)} | Lng: ${lng.toFixed(4)}
                        </p>
                    </div>
                `;

                // 2. Real-time Marker Update
                if (markers[name]) {
                    markers[name].setLatLng(pos); // Marker ko bina delete kiye move karega
                } else {
                    markers[name] = L.marker(pos).addTo(map).bindTooltip(name, {permanent: true});
                    paths[name] = L.polyline([], {color: '#63b3ed'}).addTo(map);
                }
                
                // Path line update
                paths[name].addLatLng(pos);
            }
        });
    }, err => {
        console.error("Firebase Error: ", err);
    });
}
    function listenToAlerts() {
        db.collection("alerts").where("timestamp", ">", new Date(Date.now() - 60000))
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                if (change.type === "added") {
                    userAlerts.add(change.doc.data().userName);
                    document.getElementById('sosSound').play().catch(() => {});
                }
            });
        });
    }

    function focusUser(lat, lng) { map.setView([lat, lng], 16); }

    function clearAllPaths() {
        for (let key in paths) { paths[key].setLatLngs([]); }
        alert("Map history cleared!");
    }

    function deleteUser(name, event) {
        event.stopPropagation();
        if(confirm(`Delete ${name}?`)) {
            db.collection("locations").doc(name).delete();
            if(markers[name]) map.removeLayer(markers[name]);
            if(paths[name]) map.removeLayer(paths[name]);
            delete markers[name]; delete paths[name];
        }
    }

    function getRandomColor() {
        const colors = ['#63b3ed', '#f6ad55', '#68d391', '#f687b3', '#9f7aea', '#4fd1c5'];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    window.onload = initMap;
</script>
</body>
</html>