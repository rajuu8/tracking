<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Live Map</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; background: #1a202c; color: white; }
        #sidebar { width: 320px; background: #1a202c; padding: 20px; border-right: 1px solid #2d3748; overflow-y: auto; }
        #map { flex: 1; z-index: 1; }
        .user-card { background: #2d3748; padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; position: relative; border: 1px solid transparent; }
        .user-card:hover { border-color: #63b3ed; }
        .delete-btn { position: absolute; top: 10px; right: 10px; color: #f56565; cursor: pointer; font-weight: bold; }
        .battery-tag { background: #234e33; color: #48bb78; padding: 2px 6px; border-radius: 4px; font-size: 12px; float: right; }
        .btn-clear { background: #4a5568; color: white; border: none; padding: 10px; width: 100%; border-radius: 8px; cursor: pointer; margin-bottom: 15px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Admin üõ°Ô∏è</h2>
    <button class="btn-clear" onclick="clearHistory()">üßπ Clear Map History</button>
    <div id="user-list">Fetching...</div>
</div>
<div id="map"></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCZz90P8npkRcL0ZctIelDFbKRN48BsZzk",
        authDomain: "tracking-7494e.firebaseapp.com",
        projectId: "tracking-7494e",
        storageBucket: "tracking-7494e.firebasestorage.app",
        messagingSenderId: "861816870090",
        appId: "1:861816870090:web:4dec49659b3806fcd49033"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let map, markers = {}, paths = {};

    function initMap() {
        map = L.map('map').setView([20.59, 78.96], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        listenLive();
    }

    function listenLive() {
        db.collection("locations").onSnapshot(snap => {
            document.getElementById('user-list').innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                const id = doc.id;
                if(!d.lat || !d.lng) return;

                const lat = parseFloat(d.lat);
                const lng = parseFloat(d.lng);

                // Sidebar Update
                document.getElementById('user-list').innerHTML += `
                    <div class="user-card" onclick="map.setView([${lat}, ${lng}], 16)">
                        <span class="delete-btn" onclick="deleteUser('${id}', event)">√ó</span>
                        <strong>${id}</strong> <span class="battery-tag">üîã${d.battery}%</span>
                        <div style="font-size:11px; margin-top:5px; color:#cbd5e0;">Updated: ${d.lastUpdate ? d.lastUpdate.toDate().toLocaleTimeString() : '...'}</div>
                    </div>
                `;

                // Map Update
                if (markers[id]) {
                    markers[id].setLatLng([lat, lng]);
                } else {
                    markers[id] = L.marker([lat, lng]).addTo(map).bindTooltip(id, {permanent:true});
                    paths[id] = L.polyline([], {color: '#63b3ed'}).addTo(map);
                }
                paths[id].addLatLng([lat, lng]);
            });
        });
    }

    function deleteUser(id, e) {
        e.stopPropagation();
        if(confirm("Delete " + id + "?")) {
            db.collection("locations").doc(id).delete();
            if(markers[id]) map.removeLayer(markers[id]);
            if(paths[id]) map.removeLayer(paths[id]);
            delete markers[id]; delete paths[id];
        }
    }

    function clearHistory() {
        for(let k in paths) paths[k].setLatLngs([]);
        alert("History Cleared!");
    }

    window.onload = initMap;
</script>
</body>
</html>